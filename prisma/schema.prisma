// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for NextAuth authentication
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  
  // SolidWriter specific fields
  projects      Project[]
  voiceProfiles VoiceProfile[]
  generationJobs GenerationJob[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// SolidWriter models

// Project model for organizing writing projects
model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  contents    GeneratedContent[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

// VoiceProfile model for storing user's writing style embeddings
model VoiceProfile {
  id           String   @id @default(cuid())
  name         String   // User-defined name for the voice profile
  description  String?  // Optional description of the writing style
  
  // FIXED: Added '?' to make this optional
  elevenLabsId String?
  
  // Writing samples as JSON array of strings
  samples      String?   @db.Text 
  
  // pgvector embedding for similarity search
  embedding    Float[]  // Array of floats for vector storage
  
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Metadata for the embedding
  model        String?   
  dimensions   Int?      
  
  // ADDED: Back-relation to GenerationJob
  generationJobs GenerationJob[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([userId])
  @@index([userId, name])
}

// GenerationJob model for tracking AI generation tasks
model GenerationJob {
  id          String   @id @default(cuid())
  
  // User who created this job
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Generation parameters
  topic       String
  outline     String?  // JSON string of the outline structure
  context     String?  // JSON string containing context object
  
  // Voice profile reference
  voiceProfileId String?
  voiceProfile   VoiceProfile? @relation(fields: [voiceProfileId], references: [id])
  
  // Generation status and results
  status      GenerationStatus @default(PENDING)
  content     String?  // Generated content in markdown format
  metadata    String?  // JSON string for additional metadata
  
  // Performance tracking
  tokenUsage  Int?     // Total tokens used
  duration    Int?     // Generation time in milliseconds
  
  error       String?  // Error message if generation failed
  
  // SEO and scoring data
  solidScore  Int?     // SEO score (0-100)
  readability Float?   // Readability score
  keywordDensity String? // JSON string of keyword analysis
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  
  // Relationships
  generatedContent     GeneratedContent?
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// GeneratedContent model for storing completed generated articles
model GeneratedContent {
  id        String   @id @default(cuid())
  
  // Link to project and job
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  jobId     String   @unique
  job       GenerationJob @relation(fields: [jobId], references: [id])
  
  // Content fields
  title     String
  content   String   // Final content in markdown or HTML
  format    ContentFormat @default(MARKDOWN) // MARKDOWN or HTML
  
  // SEO and metadata
  solidScore      Int?   // SEO score (0-100)
  readability     Float? // Readability score
  wordCount       Int?   // Word count
  readingTime     Int?   // Estimated reading time in minutes
  
  // Export formats available
  exports     ContentExport[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([createdAt])
}

// ContentExport model for tracking export history
model ContentExport {
  id                String   @id @default(cuid())
  
  // Link to generated content
  generatedContentId String
  generatedContent   GeneratedContent @relation(fields: [generatedContentId], references: [id], onDelete: Cascade)
  
  // Export details
  format            ExportFormat
  fileUrl          String?  // URL to exported file (if stored)
  fileSize         Int?     // File size in bytes
  
  // User who exported
  exportedBy       String   // User ID (stored as string for simplicity)
  
  createdAt        DateTime @default(now())
  
  @@index([generatedContentId])
  @@index([exportedBy])
  @@index([createdAt])
}

// Enums for better type safety
enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ContentFormat {
  MARKDOWN
  HTML
  PDF
}

enum ExportFormat {
  PDF
  DOCX
  HTML
  MARKDOWN
  TXT
}
